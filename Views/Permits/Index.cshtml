@{
    ViewData["Title"] = "View Permit List";
}
@model PermitIndexViewModel
@using PemitManagement.Data.Enums
@using System.Collections.Generic
<link rel="stylesheet" href="~/css/permits.css" />

<div class="page-header text-center mb-2">
    <h2>Permits</h2>
    <p class="text-muted">View permits, their details and observation status. The maximum entries shown per page is 10 by default.</p>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between">
        <span>Filters</span>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleFilters">Collapse</button>
    </div>

    <div class="card-body" id="filterPanel">
        <form method="get">
            <div class="row g-3">
                <div class="col-md-3">
                    <label>Permit Number</label>
                    <input class="form-control" asp-for="Filters.PermitNumber" />
                </div>

                <div class="col-md-3">
                    <label>Employee</label>
                    <select class="form-select" asp-for="Filters.EmployeeId" asp-items="Model.Employees">
                        <option value="">All</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label>Permit Type</label>
                    <select class="form-select" asp-for="Filters.PermitTypeId" asp-items="Model.PermitTypes">
                        <option value="">All</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label>Location</label>
                    <select class="form-select" asp-for="Filters.LocationId" asp-items="Model.Locations">
                        <option value="">All</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label>Status</label>
                    <select class="form-select" asp-for="Filters.Status">
                        <option value="">All</option>
                        <option value="1">Open</option>
                        <option value="0">Closed</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label>Date Range</label>
                    <select asp-for="Filters.DatePreset"
                            class="form-select"
                            onchange="onDatePresetChange(this)">
                        <option value="AllTime">All Time</option>
                        <option value="Last7Days">Last 7 Days</option>
                        <option value="Last30Days">Last 30 Days</option>
                        <option value="ThisMonth">This Month</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label>Date From</label>
                    <input type="date" class="form-control" asp-for="Filters.FromDate" />
                </div>

                <div class="col-md-3">
                    <label>Date To</label>
                    <input type="date" class="form-control" asp-for="Filters.ToDate" />
                </div>

                <div class="col-md-3">
                    <label>Violations</label>
                    <select class="form-select" asp-for="Filters.ViolationFilter">
                        <option value="">All</option>
                        <option value="With">With Violations</option>
                        <option value="Without">Without Violations</option>
                    </select>
                </div>
            </div>

            <div class="mt-3 d-flex gap-2">
                <button class="btn btn-orange">Search</button>
                <a asp-action="Index" class="btn btn-outline-secondary">Clear</a>

                <a asp-action="ExportCsv"
                   asp-route-PermitNumber="@Model.Filters.PermitNumber"
                   asp-route-EmployeeId="@Model.Filters.EmployeeId"
                   asp-route-PermitTypeId="@Model.Filters.PermitTypeId"
                   asp-route-LocationId="@Model.Filters.LocationId"
                   asp-route-Status="@Model.Filters.Status"
                   asp-route-FromDate="@Model.Filters.FromDate"
                   asp-route-ToDate="@Model.Filters.ToDate"
                   class="btn btn-success ms-auto">
                    Export CSV
                </a>

                <a asp-action="ExportExcel"
                   asp-route-PermitNumber="@Model.Filters.PermitNumber"
                   asp-route-EmployeeId="@Model.Filters.EmployeeId"
                   asp-route-PermitTypeId="@Model.Filters.PermitTypeId"
                   asp-route-LocationId="@Model.Filters.LocationId"
                   asp-route-Status="@Model.Filters.Status"
                   asp-route-FromDate="@Model.Filters.FromDate"
                   asp-route-ToDate="@Model.Filters.ToDate"
                   class="btn btn-primary">
                    Export Excel
                </a>

            </div>
        </form>
    </div>
</div>

<div class="card-header mb-2">Permit List</div>

<div class="card">
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Permit #</th>
                    <th>Employee</th>
                    <th>Type</th>
                    <th>Location</th>
                    <th>Agency</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Violations</th>
                    <th class="action">Actions</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var p in Model.Permits)
                {
                    <tr>
                        <td>@p.PermitNumber</td>
                        <td>@p.Employee</td>
                        <td>@p.Type</td>
                        <td>@p.Location</td>
                        <td>@p.Agency</td>
                        <td>@p.WorkDate?.ToString("dd MMM yyyy")</td>
                        <td class="text-center">
                            <span class="status-badge @(p.Status == PermitStatus.Open ? "status-open" : "status-closed")">
                                @p.Status
                            </span>
                        </td>

                        <td class="text-center">
                            <span class="violation-badge @(p.ViolationCount == 0 ? "badge-success" : "badge-danger")">
                                @p.ViolationCount
                            </span>
                        </td>

                        <td class="actions-cell">
                            <div class="action-buttons">
                                <a asp-controller="Permits"
                                   asp-action="Permit"
                                   asp-route-id="@p.Id"
                                   class="btn btn-sm btn-view">
                                    View
                                </a>

                                @if (User.HasClaim("permission", "close_permits"))
                                {
                                    <button class="btn btn-sm @(p.Status == PermitStatus.Open ? "btn-close-permit" : "btn-open-permit")"
                                            data-bs-toggle="modal"
                                            data-bs-target="#permitStatusModal">
                                        @(p.Status == PermitStatus.Open ? "Close" : "Reopen")
                                    </button>
                                }
                            </div>
                            
                            @await Html.PartialAsync(
                            "_ConfirmModal",
                                new ConfirmModalViewModel
                                {
                                    ModalId = "permitStatusModal",
                                    Title = $"{(p.Status == PermitStatus.Open ? "Close Permit" : "Reopen Permit")}",
                                    BodyHtml = $"Are you sure you want to <strong>{(p.Status == PermitStatus.Open ? "Close" : "Reopen")}</strong> permit <strong>{p.PermitNumber}</strong>?<br/>All related observations will also be updated.",
                                    ConfirmAction = "ToggleStatus",
                                    Controller = "Permits",
                                    EntityId = p.Id,
                                    ConfirmButtonClass = p.Status == PermitStatus.Open ? "btn-danger" : "btn-warning"
                                }
                            )
                            
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @{
        int current = Model.Filters.Page;
        int total = Model.TotalPages;
        int start = Math.Max(1, current - 2);
        int end = Math.Min(total, current + 2);
    }

    <nav>
        <ul class="pagination justify-content-center mt-2 mb-2">

            <!-- Previous -->
            <li class="page-item @(current == 1 ? "disabled" : "")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-PermitNumber="@Model.Filters.PermitNumber"
                   asp-route-EmployeeId="@Model.Filters.EmployeeId"
                   asp-route-PermitTypeId="@Model.Filters.PermitTypeId"
                   asp-route-LocationId="@Model.Filters.LocationId"
                   asp-route-Status="@Model.Filters.Status"
                   asp-route-DatePreset="@Model.Filters.DatePreset"
                   asp-route-FromDate="@Model.Filters.FromDate"
                   asp-route-ToDate="@Model.Filters.ToDate"
                   asp-route-page="@(current - 1)">
                    Previous
                </a>
            </li>

            <!-- Page numbers -->
            @for (int i = start; i <= end; i++)
            {
                <li class="page-item @(i == current ? "active" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-PermitNumber="@Model.Filters.PermitNumber"
                       asp-route-EmployeeId="@Model.Filters.EmployeeId"
                       asp-route-PermitTypeId="@Model.Filters.PermitTypeId"
                       asp-route-LocationId="@Model.Filters.LocationId"
                       asp-route-Status="@Model.Filters.Status"
                       asp-route-DatePreset="@Model.Filters.DatePreset"
                       asp-route-FromDate="@Model.Filters.FromDate"
                       asp-route-ToDate="@Model.Filters.ToDate"
                       asp-route-page="@i">
                        @i
                    </a>
                </li>
            }

            <!-- Next -->
            <li class="page-item @(current >= total ? "disabled" : "")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-PermitNumber="@Model.Filters.PermitNumber"
                   asp-route-EmployeeId="@Model.Filters.EmployeeId"
                   asp-route-PermitTypeId="@Model.Filters.PermitTypeId"
                   asp-route-LocationId="@Model.Filters.LocationId"
                   asp-route-Status="@Model.Filters.Status"
                   asp-route-DatePreset="@Model.Filters.DatePreset"
                   asp-route-FromDate="@Model.Filters.FromDate"
                   asp-route-ToDate="@Model.Filters.ToDate"
                   asp-route-page="@(current + 1)">
                    Next
                </a>
            </li>

        </ul>
    </nav>

</div>

@section Scripts {
    <script src="@Url.Content("~/js/permit-index.js")"></script>
}
